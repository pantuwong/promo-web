<template id="app">
  <v-app class="ma-0">
    <v-app-bar app color="white" dark elevation="0">
      <div class="d-flex align-center">
        <div class="logo-wrapper">
          <div class="logo logo-foodpanda">
            <div class="svg-logo-wrapper">
              <!--?xml version="1.0" encoding="utf-8"?-->
              <!-- Generator: Adobe Illustrator 21.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
              <svg
                version="1.1"
                height="26"
                width="26"
                class="logo-icon"
                id="Layer_1"
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                x="0px"
                y="0px"
                viewBox="0 0 198.2 200.3"
                xml:space="preserve"
              >
                <g>
                  <g>
                    <path
                      class="st0"
                      d="M99,148c13.5,0,24.4-9.6,24.4-21.4H74.7C74.7,138.4,85.5,148,99,148z"
                    ></path>
                    <g>
                      <path
                        class="st0"
                        d="M181.3,46c5.5-4.8,9.1-11.8,9.1-19.8c0-14.4-11.7-26.1-26.2-26.1c-9.3,0-17.4,4.8-22,12
				c-13-6.3-27.6-9.9-43-9.9s-30,3.5-43,9.8c-4.7-7.2-12.7-12-22-12C19.8,0,8,11.7,8,26.1c0,7.9,3.5,15,9,19.7
				C6.3,61.6,0,80.7,0,101.2c0,54.7,44.5,99.1,99.1,99.1s99.1-44.4,99.1-99.1C198.3,80.9,192,61.8,181.3,46z M99.2,192.8
				c-50.4,0-91.4-41-91.4-91.4c0-19,5.8-36.6,15.7-51.2c9-13.2,21.4-24,35.8-31c12-5.9,25.5-9.2,39.8-9.2s27.8,3.3,39.9,9.2
				c14.5,7,26.8,17.8,35.8,31c9.9,14.6,15.7,32.2,15.7,51.2C190.6,151.8,149.6,192.8,99.2,192.8z"
                      ></path>
                      <path
                        class="st0"
                        d="M99,120.5c1.5,0.4,17.2-4.9,17.2-12.3c0-4.1-12.7-4.9-17.2-4.9c-4.4,0-17.2,0.8-17.2,4.9
				C81.8,115.6,97.5,120.9,99,120.5z"
                      ></path>
                      <path
                        class="st0"
                        d="M156.6,58.5c-8.6-5.7-27.7-9.1-35.1,0.8c0,0-9.4,10.1-0.2,20.6c9.3,10.5,16.4,20.3,18.5,28.8
				s5.5,12,12.4,12.1c6.9,0,20.1-10.5,21.8-27.4C175.7,76.5,165.2,64.1,156.6,58.5z M136.9,80.1c-2.9,0-5.2-2.3-5.2-5.2
				s2.4-5.2,5.2-5.2c2.9,0,5.2,2.3,5.2,5.2C142,77.7,139.7,80.1,136.9,80.1z"
                      ></path>
                      <path
                        class="st0"
                        d="M76.5,59.2c-7.5-9.8-26.6-6.5-35.1-0.8c-8.6,5.7-19.1,18-17.4,34.9c1.6,16.9,14.9,27.4,21.8,27.4
				s10.3-3.5,12.4-12.1c2.1-8.5,9.3-18.3,18.5-28.8S76.5,59.2,76.5,59.2z M62.7,80.1c-2.9,0-5.2-2.3-5.2-5.2s2.3-5.2,5.2-5.2
				c2.9,0,5.2,2.3,5.2,5.2C67.8,77.7,65.5,80.1,62.7,80.1z"
                      ></path>
                    </g>
                  </g>
                </g>
              </svg>
              <!--?xml version="1.0" encoding="utf-8"?-->
              <!-- Generator: Adobe Illustrator 21.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
              <svg
                version="1.1"
                height="30px"
                width="133px"
                d="Layer_1"
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                x="0px"
                y="0px"
                viewBox="150 -45 745 250"
                xml:space="preserve"
              >
                <g class="svg-stroke-container">
                  <g>
                    <path
                      class="st0"
                      d="M0,52.3h18.7V35c0-21,11.7-35,35-35l11.7,2.3v21L52.6,21c-7,0-10.5,4.7-10.5,11.7v19.6h23.3v21H42.1V162H18.8
			V73.3H0.1L0,52.3L0,52.3z"
                    ></path>
                    <path
                      class="st0"
                      d="M125.8,50c30.3,0,57.2,23.3,57.2,57.2c0,33.8-26.8,57.2-57.2,57.2c-30.3,0-57.2-23.3-57.2-57.2
			C68.7,73.3,95.5,50,125.8,50z M125.8,143.3c22.2,0,33.8-16.3,33.8-36.2c0-19.8-11.7-36.2-33.8-36.2c-22.2,0-33.8,16.3-33.8,36.2
			S103.7,143.3,125.8,143.3z"
                    ></path>
                    <path
                      class="st0"
                      d="M250.4,50c30.3,0,57.2,23.3,57.2,57.2c0,33.8-26.8,57.2-57.2,57.2s-57.2-23.3-57.2-57.2
			C193.3,73.3,220.1,50,250.4,50z M250.4,143.3c22.2,0,33.8-16.3,33.8-36.2c0-19.8-11.7-36.2-33.8-36.2c-22.2,0-33.8,16.3-33.8,36.2
			S228.3,143.3,250.4,143.3z"
                    ></path>
                    <path
                      class="st0"
                      d="M429.9,162h-21l-2.3-9.3l-1.2-1.2l-1.2,1.2c-7,7-18.7,11.7-30.3,11.7c-30.3,0-56-23.3-56-57.2
			c0-33.8,25.7-57.2,56-57.2c11.4,0,23.3,4.7,30.3,11.7l1.2,1.2l1.2-1.2V0h23.3V162z M375.1,71c-22.2,0-34.1,16.3-34.1,36.2
			c0,19.8,11.9,36.2,34.1,36.2c19.8,0,33.8-16.3,33.8-36.2S394.9,71,375.1,71z"
                    ></path>
                    <path
                      class="st0"
                      d="M453.3,52.3h21l2.1,9.3l1.4,1.2l1.2-1.2c7-7,18.7-11.7,30.3-11.7c30.3,0,56,23.3,56,57.2
			c0,33.8-25.7,57.2-56,57.2c-11.4,0-23.3-4.7-30.3-11.7l-1.2-1.2l-1.4,1.2v58.8h-23.1V52.3z M508.1,143.3
			c22.2,0,33.8-16.3,33.8-36.2c0-19.8-11.7-36.2-33.8-36.2c-19.8,0-33.8,16.3-33.8,36.2S488.3,143.3,508.1,143.3z"
                    ></path>
                    <path
                      class="st0"
                      d="M624,93.9h19.1v-4.8c0-13.2-9-19.3-21.5-19.3c-10.1,0-16.9,4.8-20.6,14.7l-20.9-4.4
			c4.6-18.7,20.6-30.5,41.7-30.5c29.4,0,44.1,14.5,44.1,43.7V162h-19.3l-2.2-14.5c-7.7,10.8-19.1,16.3-34.3,16.3
			c-19.5,0-34-11.6-34-33.6C576.1,107.5,595.3,93.9,624,93.9z M614.1,143.5c7.7,0,14.5-2.4,20.2-7.2c5.9-5.1,8.8-11.9,8.8-20.9V113
			h-20c-14.1,0-22.8,6.6-22.8,17.1C600.3,138,605.1,143.5,614.1,143.5z"
                    ></path>
                    <path
                      class="st0"
                      d="M687.5,52.3h21l2.3,9.3l1.2,1.2l1.2-1.2c4.7-7,16.3-11.7,25.7-11.7c28,0,44.3,18.7,44.3,44.3v67.7h-23.3V94.2
			c-0.7-14.9-7.9-23.3-23.3-23.3c-13.8,0-25.2,11.2-25.7,24.7v66.3h-23.3L687.5,52.3L687.5,52.3z"
                    ></path>
                    <path
                      class="st0"
                      d="M910.2,162h-21l-2.3-9.3l-1.2-1.2l-1.2,1.2c-7,7-18.7,11.7-30.3,11.7c-30.3,0-56-23.3-56-57.2
			c0-33.8,25.7-57.2,56-57.2c11.4,0,23.3,4.7,30.3,11.7l1.2,1.2l1.2-1.2V0h23.3V162z M855.3,71c-22.2,0-34.1,16.3-34.1,36.2
			c0,19.8,11.9,36.2,34.1,36.2c19.8,0,33.8-16.3,33.8-36.2C889.2,87.3,875.2,71,855.3,71z"
                    ></path>
                    <path
                      class="st0"
                      d="M976.6,93.9h19.1v-4.8c0-13.2-9-19.3-21.5-19.3c-10.1,0-16.9,4.8-20.6,14.7l-20.9-4.4
			c4.6-18.7,20.6-30.5,41.7-30.5c29.4,0,44.1,14.5,44.1,43.7V162h-19.3l-2.2-14.5c-7.7,10.8-19.1,16.3-34.3,16.3
			c-19.5,0-34-11.6-34-33.6C928.7,107.5,947.8,93.9,976.6,93.9z M966.7,143.5c7.7,0,14.5-2.4,20.2-7.2c5.9-5.1,8.8-11.9,8.8-20.9
			V113h-20c-14.1,0-22.8,6.6-22.8,17.1C952.9,138,957.7,143.5,966.7,143.5z"
                    ></path>
                  </g>
                </g>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <v-spacer></v-spacer>

      <v-btn class="mr-0" icon outlined small color="primary" @click="openLoginLogoutDialog">
        <v-icon>mdi-account</v-icon>
      </v-btn>
    </v-app-bar>

    <v-main> 
      <Banner />
      <Content />
    </v-main>

    <v-footer padless>
      <v-col
        class="text-center"
        style="background-color: #d70f64; color: white;"
        cols="12"
      >
        @2021 foodpanda
      </v-col>
    </v-footer>

    <v-dialog v-model="logout_dialog" persistent max-width="600px">
      <v-card>
        <v-card-title style="background-color: #d70f64; color: #fff;">
          <span class="text-h5">Logout</span>
        </v-card-title>
        <v-card-text>
          <v-container>
            <v-row>
              <v-col cols="12" text-center>
                คุณต้องการจะออกจากระบบใช่หรือไม่ ?
              </v-col>
            </v-row>
          </v-container>
        </v-card-text>
        <v-card-actions style="display: block;">
          <v-spacer></v-spacer>
          <v-row>
            <v-col cols="12" align="right">
              <v-btn color="primary darken-1" text @click="logout_dialog = false">
                Cancel
              </v-btn>
              <v-btn  color="primary darken-1" text @click="logout">
                Logout
              </v-btn>
            </v-col>
          </v-row>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <v-dialog v-model="login_dialog" persistent max-width="600px">
      <v-card>
        <v-card-title style="background-color: #d70f64; color: #fff;">
          <span class="text-h5">Login</span>
        </v-card-title>
        <v-card-text>
          <v-container>
            <v-row>
              <v-col cols="12">
                <v-text-field ma-2 v-model="vendorCode" label="Vendor Code*" required 
                hint="วิธีการดูรหัสร้านค้า: เปิดแท็บเล็ต -> เข้าไปที่เมนู 'ตั้งค่า' -> รหัสร้านค้าจะอยู่ในส่วน 'หมายเลขร้านบนแพลตฟอร์ม' เช่น a3bc"></v-text-field>
              </v-col>
            </v-row>
            <v-row>
              <v-col cols="12">
                <v-text-field v-model="email" label="Email*" required 
                hint="กรุณากรอกอีเมลที่ท่านใช้ลงทะเบียนเป็นพาร์ทเนอร์กับ foodpanda จากนั้นกดที่ปุ่ม 'Request OTP' ด้านล่างเพื่อส่งรหัสไปยังอีเมล"></v-text-field>
              </v-col>
            </v-row>
            <v-row v-if="isRequestedOTP"> 
              <v-col cols="12">
                <v-text-field v-model="password" label="Password*" type="password" required
                :hint=emailHint></v-text-field>
              </v-col>
            </v-row>
          </v-container>
        </v-card-text>
        <v-card-actions style="display: block;">
          <v-spacer></v-spacer>
          <v-row>
            <v-col cols="3" align="center">
              <v-btn v-if="!isRequestedOTP" color="primary" :disabled="otp_disable" @click="requestOTP" small elevation="0">Request OTP</v-btn>
            </v-col>
            <v-col cols="9" align="right">
              <v-btn color="primary darken-1" text @click="login_dialog = false">
                Cancel
              </v-btn>
              <v-btn v-if="isRequestedOTP" color="primary darken-1" text @click="login">
                Login
              </v-btn>
            </v-col>
          </v-row>
        </v-card-actions>
      </v-card>
    </v-dialog>
    <v-snackbar
      :timeout="timeout"
      v-model="snackbar"
      top
      right 
      :color="snackbarColor"
    >
      {{ snackbarText }}

      <template v-slot:action="{ attrs }">
        <v-btn
          color="#fff"
          text
          v-bind="attrs"
          @click="snackbar = false"
        >
          Close
        </v-btn>
      </template>
    </v-snackbar>
  </v-app>
</template>

<script>
import { mapState, mapActions } from "vuex";
import Banner from './components/Banner.vue'
import Content from './components/Content.vue'
import axios from "axios";
export default {
  name: "App",

  components: {
    Banner,
    Content
  },

  data: () => ({
    //
    login_dialog: false,
    logout_dialog: false,
    otp_disable: true,
    isRequestedOTP: false,
    email: '',
    password: '',
    vendorCode: '',
    snackbar: false,
    snackbarColor: '#41A746',
    snackbarText: 'test',
    timeout: 5000,
  }),

  computed: {
     ...mapState(["isLogin"]),
    emailHint() {
      return `กรอกรหัสที่ได้รับจากอีเมลชื่อ '${this.email}' และคลิก 'Login'`
    }
  },

  methods: {
    ...mapActions(["setIsLogin"]),
    openLoginLogoutDialog() {
      if (this.isLogin) {
        this.login_dialog = false
        this.logout_dialog = true
      } else {
        this.vendorCode = '',
        this.email = '',
        this.password = '',
        this.login_dialog = true
        this.isRequestedOTP = false
        this.logout_dialog = false
      }
    },
    async requestOTP() {
      let data = JSON.stringify({
        vendor_code: this.vendorCode,
        email: this.email
      });

      let config = {
        method: "post",
        url: `${process.env.VUE_APP_API_URL}/api/otp`,
        headers: {
          "Content-Type": "application/json"
        },
        data: data
      };
      var otpResult = await axios(config)
        .then(function(response) {
          console.log('otp return')
          return response.data;
        })
        .catch(function(error) {
          console.log(error);
        });
      
      if (otpResult != null && otpResult != undefined) {
        if (otpResult.success) {
          this.isRequestedOTP = true
          this.snackbarColor = "#41A746"
          this.snackbarText = `รหัสผ่านชั่วคราวได้ส่งไปยังอีเมล์ ${this.email} แล้ว`
          this.snackbar = true
        } else {
          this.snackbarColor = "#DC3A45"
          if (otpResult.message === 'DATA_MISSING') {
            this.snackbarText = `ไม่ได้รับข้อมูล Vendor Code หรือ อีเมล์`
          } else if (otpResult.message === 'VENDOR_NOT_FOUND') {
            this.snackbarText = `ไม่พบข้อมูลของ Vendor Code : ${this.vendorCode}`
          } else if (otpResult.message === 'VENDOR_EMAIL_NOT_MATCH') {
            this.snackbarText = `อีเมล์ที่กรอกไม่ถูกต้อง`
          } else if (otpResult.message === 'SEND_MAIL_FAIL') {
            this.snackbarText = `ไม่สามารถส่งอีเมล์ไปยัง ${this.email} ได้`
          }
          this.snackbar = true
        }
      } else {
          this.snackbarColor = "#DC3A45"
          this.snackbarText = `มีปัญหาขัดข้องทางเทคนิค`
          this.snackbar = true
      }
    },
    async login() { 
      let data = JSON.stringify({
        email: this.email,
        otp: this.password
      });
     let config = {
        method: "post",
        url: `${process.env.VUE_APP_API_URL}/api/login`,
        headers: {
          "Content-Type": "application/json"
        },
        data: data
      };
      var loginResult = await axios(config)
        .then(function(response) {
          console.log('login return')
          return response.data;
        })
        .catch(function(error) {
          console.log(error);
        });
      if (loginResult != null && loginResult != undefined) {
        if (loginResult.success) {
          this.isRequestedOTP = true
          this.snackbarColor = "#41A746"
          this.snackbarText = `Login สำเร็จ!!`
          this.snackbar = true
          this.login_dialog = false
          this.setIsLogin(true)
        } else {
          this.snackbarColor = "#DC3A45"
          if (loginResult.message === 'NO_EMAIL_OR_OTP') {
            this.snackbarText = `ไม่ได้รับข้อมูล อีเมล์ หรือ รหัสผ่าน`
            this.isRequestedOTP = false
          } else if (loginResult.message === 'PLEASE_REQUEST_OTP') {
            this.snackbarText = `ไม่พบรหัสผ่านชั่วคราวของ Vendor Code ${this.vendorCode} กรุณาดำเนินการใหม่อีกครั้ง`
            this.isRequestedOTP = false
          } else if (loginResult.message === 'OTP_EXPIRE') {
            this.snackbarText = `รหัสผ่านชั่วคราวหมดอายุแล้ว กรุณาดำเนินการใหม่อีกครั้ง`
            this.isRequestedOTP = false
          } else if (loginResult.message === 'WRONG_OTP') {
            this.snackbarText = `รหัสผ่านชั่วคราวที่กรอกไม่ถูกต้อง`
          }
          this.snackbar = true
        }
      } else {
          this.snackbarColor = "#DC3A45"
          this.snackbarText = `มีปัญหาขัดข้องทางเทคนิค`
          this.snackbar = true
      }
      
    },
    async logout() { 
      let data = JSON.stringify({
        email: this.email,
      });
     let config = {
        method: "post",
        url: `${process.env.VUE_APP_API_URL}/api/logout`,
        headers: {
          "Content-Type": "application/json"
        },
        data: data
      };
      var logoutResult = await axios(config)
        .then(function(response) {
          console.log('login return')
          return response.data;
        })
        .catch(function(error) {
          console.log(error);
        });
        if (logoutResult != null && logoutResult != undefined) {
          if (logoutResult.success) {
            this.isRequestedOTP = true
            this.snackbarColor = "#41A746"
            this.snackbarText = `Logout สำเร็จ!!`
            this.snackbar = true
            this.setIsLogin(false)
          } else {
            this.snackbarColor = "#DC3A45"
            this.snackbarText = `มีปัญหาขัดข้องทางเทคนิค`
            this.snackbar = true
          }
        } else {
            this.snackbarColor = "#DC3A45"
            this.snackbarText = `มีปัญหาขัดข้องทางเทคนิค`
            this.snackbar = true
        }

        this.logout_dialog = false
    }
  },

  watch: {
    email(val) {
      if (val==='' || !val.includes('@')) {
        this.otp_disable = true;
      } else {
        this.otp_disable = false;
      }
    }
  }
};
</script>

<style>
#app {
  font-family: 'Helvetica', 'Arial', sans-serif;
}
.logo-wrapper {
  flex: 1 0 auto;
}
.st0 {
  fill: #d70f64;
}
.v-text-field__details {
    display: flex;
    flex: 1 0 auto;
    max-width: 100%;
    min-height: 14px;
    overflow: visible;
}
</style>
